<main class="reimbursement-ops">
  <header class="reimbursement-ops__header">
    <div>
      <p class="eyebrow">Reimbursement</p>
      <h1>COO approvals</h1>
      <p class="subtitle">Close approved reimbursement claims.</p>
    </div>
    <div class="actions">
      <a class="ghost button-link" routerLink="/">Back to home</a>
    </div>
  </header>

  @if (!isAuthorized) {
    <p class="empty">{{ statusMessage }}</p>
  } @else {
    @if (statusMessage) {
      <p class="empty">{{ statusMessage }}</p>
    } @else {
      <section class="reimbursement-section">
        <div class="section-header">
          <h2>Approved reimbursements</h2>
          <span class="pill">{{ approvals.length }}</span>
        </div>
        @if (approvals.length) {
          <div class="reimbursement-ops__list">
            @for (item of approvals; track item.id) {
              <article class="reimbursement-card">
                <div class="reimbursement-card__top">
                  <div>
                    <span class="pill soft">Approved</span>
                    <strong>Reimbursement · {{ item.category }}</strong>
                    <span class="meta">{{ item.employee || 'Employee' }}</span>
                  </div>
                  <div class="amount">₹{{ item.amount }}</div>
                </div>
                @if (item.notes) {
                  <div class="note-card">
                    <span>Request note</span>
                    <p>{{ item.notes }}</p>
                  </div>
                }
                @if (item.note) {
                  <div class="note-card completion">
                    <span>Completion note</span>
                    <p>{{ item.note }}</p>
                  </div>
                }
                <div class="reimbursement-card__actions">
                  <label>
                    Status
                    <select [(ngModel)]="item.statusChoice">
                      <option value="Reimbursement complete">Reimbursement complete</option>
                    </select>
                  </label>
                  <label>
                    Completion note
                    <textarea
                      rows="2"
                      placeholder="Add completion note"
                      [(ngModel)]="item.note"
                    ></textarea>
                  </label>
                  <div class="actions-row">
                    @if (item.error) {
                      <p class="error">{{ item.error }}</p>
                    }
                    <button
                      class="primary"
                      type="button"
                      (click)="submitDecision(item)"
                      [disabled]="item.saving"
                    >
                      {{ item.saving ? 'Saving…' : 'Mark complete' }}
                    </button>
                  </div>
                </div>
              </article>
            }
          </div>
        } @else {
          <p class="empty">No approved reimbursements awaiting completion.</p>
        }
      </section>

      <section class="reimbursement-section">
        <div class="section-header">
          <h2>Reimbursement updates</h2>
          <span class="pill soft">{{ completed.length }}</span>
        </div>
        @if (completed.length) {
          <div class="reimbursement-ops__list">
            @for (item of completed; track item.id) {
              <button class="reimbursement-card done" type="button" (click)="openCompleted(item)">
                <div class="reimbursement-card__top">
                  <div>
                    <span class="pill">Reimbursement complete</span>
                    <strong>Reimbursement · {{ item.category }}</strong>
                    <span class="meta">{{ item.employee || 'Employee' }}</span>
                  </div>
                  <div class="amount">₹{{ item.amount }}</div>
                </div>
                @if (item.notes) {
                  <div class="note-card">
                    <span>Request note</span>
                    <p>{{ item.notes }}</p>
                  </div>
                }
                <div class="note-card completion">
                  <span>Completion note</span>
                  <p>{{ item.completionNote || 'No completion note provided.' }}</p>
                </div>
              </button>
            }
          </div>
        } @else {
          <p class="empty">No reimbursement updates logged yet.</p>
        }
      </section>
    }
  }
</main>

@if (selectedCompleted) {
  <div class="modal-backdrop" (click)="closeCompleted()"></div>
  <div class="modal" role="dialog" aria-modal="true">
    <header>
      <div>
        <p class="eyebrow">Reimbursement update</p>
        <h3>Reimbursement · {{ selectedCompleted.category }}</h3>
        <p class="subtitle">
          {{ selectedCompleted.employee || 'Employee' }} · ₹{{ selectedCompleted.amount }}
        </p>
      </div>
      <button class="ghost" type="button" (click)="closeCompleted()">Close</button>
    </header>
    <div class="modal-body">
      <div class="detail-row">
        <span>Status</span>
        <strong>{{ selectedCompleted.status }}</strong>
      </div>
      @if (selectedCompleted.notes) {
        <div class="detail-row">
          <span>Request note</span>
          <strong>{{ selectedCompleted.notes }}</strong>
        </div>
      }
      @if (selectedCompleted.completionNote) {
        <div class="detail-row">
          <span>Completion note</span>
          <strong>{{ selectedCompleted.completionNote }}</strong>
        </div>
      }
      @if (selectedCompleted.decidedAt) {
        <div class="detail-row">
          <span>Completed on</span>
          <strong>{{ selectedCompleted.decidedAt | date : 'mediumDate' }}</strong>
        </div>
      }
    </div>
    <div class="modal-actions">
      <button class="primary" type="button" (click)="closeCompleted()">Done</button>
    </div>
  </div>
}
